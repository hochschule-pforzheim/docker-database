#!/bin/bash
set -e

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
    CREATE USER $NXTGENMONDIAL_DB_USERNAME WITH PASSWORD '$NXTGENMONDIAL_DB_PASSWORD';
    CREATE USER $NXTGENMONDIAL_MONDIALDB_USERNAME WITH PASSWORD '$NXTGENMONDIAL_MONDIALDB_PASSWORD';

    REVOKE ALL ON SCHEMA public FROM PUBLIC;

    CREATE DATABASE nxtgenmondialdb;
    CREATE DATABASE mondialdb;

    REVOKE ALL ON DATABASE postgres FROM PUBLIC;
    REVOKE ALL ON DATABASE nxtgenmondialdb FROM PUBLIC;
    REVOKE ALL ON DATABASE mondialdb FROM PUBLIC;
    REVOKE ALL ON SCHEMA public FROM PUBLIC;
    REVOKE ALL PRIVILEGES ON DATABASE postgres FROM $NXTGENMONDIAL_MONDIALDB_USERNAME;
    REVOKE ALL PRIVILEGES ON DATABASE nxtgenmondialdb FROM $NXTGENMONDIAL_MONDIALDB_USERNAME;

    GRANT ALL PRIVILEGES ON DATABASE nxtgenmondialdb TO $NXTGENMONDIAL_DB_USERNAME;
    GRANT CONNECT ON DATABASE mondialdb TO $NXTGENMONDIAL_MONDIALDB_USERNAME;

EOSQL

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "nxtgenmondialdb" <<-EOSQL
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $NXTGENMONDIAL_DB_USERNAME;
EOSQL

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "mondialdb" <<-EOSQL
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO $NXTGENMONDIAL_MONDIALDB_USERNAME;
EOSQL